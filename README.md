
Spekulatio
==========

![Spekulatio: Static Site Generator](media/spekulatio-logo.png)

Spekulatio is a minimalistic static site generator and it is particularly useful
if you want:

* **To have total freedom to create your own HTML/CSS**: Spekulatio doesn't
  impose any particular elements, structure or layout.

* **To create your content using Markdown, reStructuredText, JSON or YAML**: or
  any combination of them.

* [Optionally] **Use SCSS** to write your CSS.

* **To learn quickly how to use the tool**: Spekulatio is very small. There are
  only a couple of commands to know and a handful variables to learn.

You can think of Spekulatio as a tool that helps you to create hand-coded sites.
You can use plain HTML/CSS/JS to design them while providing the content with
markup formatted files. Spekulatio also provides a templating system (Jinja2) to
allow you to define reusable parts such as headers, footers or sidebars and the
possibility of using SCSS to write your CSS.

How it works
------------

A typical Spekulatio project is composed of three folders:
```
  content/
  templates/
  build/
```
You put your content files (eg. Markdown or reStructuredText) in the `content/`
folder and the HTML templates (eg. one template for a single column layout and
another for a two-column one) in `templates/` and then run:
```
  spekulatio build
```
to create the final site in `build/`.

The final site is generated by Spekulatio iterating through every file in the
`content/` folder and performing an action depending on its type:

* **Markdown (`.md`), reStructuredText (`.rst`), JSON (`.json`) and YAML
(`.yaml`) files** are converted to HTML. You can specify inside the files which
template in `templates/` to use in each case.

* **SCSS (`.scss`) files** are converted to CSS ones.

* **Files whose name starts with underscore (`_`)** are skipped.

* **All other files** are copied literally. This includes any static files such
  as regular CSS files, images or JavaScript files. HTML files are also copied
  over without modification.

For example:
```
-------------------------------------------------------------------------
Your content files (content/)      | Generated site (build/)
-------------------------------------------------------------------------
index.md                           | index.html
another-page.md                    | another-page.html
section/                           | section/
  index.md                         |   index.html
  restructuredtext-example.rst     |   restructuredtext-example.html
static/                            | static/
  stylesheet.scss                  |   stylesheet.css
  image.png                        |   image.png
_this_file_is_ignored.txt          |
-------------------------------------------------------------------------
```

> **Note:** you can change the names and paths of the three folders using
parameters passed to the `build` command. See the [API](#API) section below for
details.

> **Note:** if you're creating your project as a repository, you may want to
add the `build/` directory to your `.gitignore` file (or equivalent for other
revision control systems other than Git).

Starting fast
-------------

If you are starting a new project, you can execute the utility command:
```
  spekulatio init <project-name>
```
to create a basic, bare-bones file structure that you can use as a base.

> **Note:** this is only a basic helper command to save time. There's nothing
special about `init` other than creating a minimal example folder structure.

Serving your site
-----------------

Once you have built your project, you can serve it with:
```
  spekulatio serve
```
This just launches an HTTP server that serves the files in the `build/`
directory. You can connect to it by pointing your browser to
`http://localhost:8000/`.

> **Note:** you can change the port used by passing a `--port=<number>` to the
parameter.

Using templates
---------------

If you just add Markdown or reStructuredText files and run `spekulatio build`,
you'll see that they are converted to HTML using a very basic layout. For
example, the file `example.md`:
```
An Example File
===============

This is just some content.
```
will be converted into:
```
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
    </head>
    <body>
        <h1>An Example File</h1>
        <p>This is just some content.</p>
    </body>
</html>
```
This is because, by default, all content files are rendered into HTML
using a very minimal default template named `spekulatio/default.html`.

You can, however, write your own templates to create any layout you want.
Spekulatio doesn't prescribe any of its parts or how they have to be defined.
You can use pure HTML and CSS to do so.

### Documents as data dictionaries

The key to understand how HTML files are generated is:

**Each content file (`.md` or `.rst`) is internally converted into a dictionary
of key-value pairs. That dictionary is, then, passed to the template specified
in a `_template` key, specified in the dictionary itself, to render the final
HTML file.**

The following example shows how a Markdown document would be converted during
the site build process into an intermediate data dictionary:
```
example.md                       |  Data dictionary
--------------------------------------------------------------------------------
---                              |
_template: my-project/post.html  |  {
title: My Title                  |    "_template": "my-project/post.htmt",
author: me                       |    "title": "My Title",
date: Jan 31, 2021               |    "author": "me",
---                              |    "date": "Jan 31, 2021",
                                 |    "_content": "<h1>Header</h1>\n<p>Text</p>"
Header                           |   }
======                           |
                                 |
Some text                        |
```
The header of the `example.md` document is a YAML excerpt known as
_front-matter_. It has to be surrounded by two lines containing three dashes
(`---`) and it is a popular way in many static site generators of providing meta
information of Markdown and reStructuredText documents. Any valid YAML, included
nested values, can be used there.

The `_template` key is used to specify which template you want to use and, if it
is not provided, the basic default template is used. The `_content` element
contains the body of the document already converted to HTML. Both `_template`
and `_content` are the two most important special key names. These key names
(all of them starting with underscore `_`) are reserved in Spekulatio and have
two purposes:

* They can be used to pass configuration parameters to the tool (like
`_template).
* They are automatically generated so you can use their value in templates (like
`_content`).

There are actually only a handful of those values. Check the [API](#API) section
for a full list.

As for the rest of the key-value pairs —those without a leading underscore—,
they can be freely defined by the user and they are passed to the templates as
they are.

#### Using JSON or YAML

JSON and YAML files in the `content/` directory are also rendered as HTML. The
only difference with Markdown and reStructuredText files is that Spekulatio
doesn't add a `_content` key in those cases.

When you use JSON or YAML as content, the first level element of the file has to
be a dictionary (having a list yields an error). That dictionary is then passed
to the template directly.

### An example template

Templates are placed in the `templates/` directory. In the case of the example
above, the path of the template from the root of the project would be:
```
  templates/my-project/post.html
```
To be used, templates are referred using their relative path to the containing
folder. For example:

* `templates/my-project/post.html` → `_template: my-project/post.html`
* `templates/foobar.html` → `_template: foobar.html`

You could, for example, write the `my-project/post.html` template like this:
```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="/static/css/styles.css">
        <title>{{ title }}</title>
    </head>
    <body>
        <div id="info">
            <p>{{ author }}</p>
            <p>{{ date }}</p>
        </div>
        <article id="content">{{ _content }}</article>
    </body>
</html>
```
As you can see, you can access the values passed to the template using
placeholders of the form: `{{ key }}`. Spekulatio uses the **Jinja2 library** as
template engine, and you can use any of the features it supports in your
template. 

The following are some examples of things that you can do. For a full list of
the functionality check the official documentation page:

  https://jinja.palletsprojects.com/en/2.11.x/templates/

#### Iterating over elements

If you have a list in the front-matter:
```yaml
---
_template: foobar.html
authors:
  - Jane
  - Jim
  - John
---
```
Then you can create a list of authors with:
```html
<ul>
  {% for author in authors %}
  <li>{{ author }}</li>
  {% endfor %}
</ul>
```

#### If statements

If you have this in your content file:
```yaml
---
_template: foobar.html
banner: true
---
```
You can conditionally display some part of the site:
```html
{% if banner %}
<div class="my-banner">...</div>
{% endif %}
```
You can also use `{% elif <condition> %}` and `{% else %}` intermediate
statements.

#### Reusing the same base layout

Imagine that you want to reuse the same header and/or footer across all your
templates. You can, then, define a base template (eg. `base.html`) like this:
```html
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="/static/css/styles.css">
        <title>{{ title }}</title>
    </head>
    <body>
        <header>My site</header>
        {% block main %}
        {% endblock %}
    </body>
</html>
```
And then, a child template (eg. `child.html`) that inherits from it:
```html
{% extends "base.html" %}

{% block main %}
<main class="two-cols">
  <article>{{ _content }}</article>
  <aside>...</aside>
</main>
{% endblock %}
```
Note that you use `{% extends <template-filename> %}` to inherit from another
template. The name of the template file has to be passed relative to the
`templates/` directory.

If you use the child template in your content file:
```yaml
---
_template: child.html
title: My Title
---

My content
----------

...
```
then the whole `main.html` template will be rendered and the `main` block will
be replaced by the one defined in `child.html`. That allow you to have multiple
children templates that inherit from the same parent one. So if you have your
base layout in the parent one, you can use the child ones to define different
layouts like single-column vs multiple columns ones or each one having different
elements altogether.

Note also:

* That you can pass variables to the child templates and use them in the parent
  templates.
* You can have multiple `block`s defined in the parent template.
* You can have more than one level of inheritance.
* You can also have default content for a `block` (by just adding HTML between
  the `{% block <name> %}` and `{% endblock %}` markers) for those cases in which
  the child template doesn't define that block in particular.

Also, as stated above,
[Jinja](https://jinja.palletsprojects.com/en/2.11.x/templates/) supports many
more features than the ones shown here. Check Jinja official documentation to
know more.

The `_values.yaml` file
-----------------------

So far, we know how to write a template and how to pass values from the content
files to them. However, imagine that you want to define a `site_name` variable.
Probably, the value for this variable doesn't change for the entire site and it
would be unpractical to have it defined in every single content file.

To make a variable available to all pages under a directory, place a
`_values.yaml` file in it. For example, you can place this `_values.yaml` file
at the root of your site:
```yaml
site_name: My Site
copyright_notice: Copyright © 2021 Me
```
and both `site_name` and `copyright_notice` will be available during the
template rendering of all pages of your site.

You could, then, for instance, have a base template with a footer like:
```
        ...
        <footer>{{ copyright_notice }}</footer>
    </body>
</html>
```

One cool thing in Spekulatio is that you can place this file in any directory
and the values will be available from that point on. Take a look at this site:

![Spekulatio: Static Site Generator](media/spekulatio-logo.png)

The image describes five subdirectories of an example site. Inside the circles, you
can see the name of the directories (`dir1`, `dir2`, …) and the variables that
are set in that directory using the `_values.yaml` file. In the case of the root
directory (`/`), `a` is set to `1` and in the case of `dir4`, `a` is set to `5`.
That means that for all pages below root (ie. all pages of the site) the value
of `a` will be `1` unless overridden. For all pages under `dir4`, `a` will be
`5`. In the same way, all pages under `dir2` will have `a` and `b` set to `2`
and `3` respectively (again, unless overridden).

This means that you could set, for example, the `_template` variable so that
all pages under `dir1` have a different layout than the pages under `dir2`.

> **Note:** One important thing to keep in mind is that only values that are
defined in the `_values.yaml` are inherited. The values defined in the
front-matter of a page only affect that particular page.

Using this data-inheritance system, you can define which layout to use in each
part of your application, which menus to show or what set of related links to
display.

> **Note:** In case you want to have content associated to a directory itself
—that is, to serve a page when the user enters the URL pointing to it (eg.
`my-domain.tld/my-directory/`)—, just add a content file named `index` with any
of the supported extensions for content files (eg. `md` or `rst`). This will
generate an `index.html` file that is automatically used by most HTTP servers as
the default page when none is specified in the URL.

### Advanced definition of values

By default, values are inherited from the point in which they are defined and
override any previous variable of the same name. However, Spekulatio offers an
advanced definition syntax using two leading underscores (`__`) that allows to
have more control over how the variable is used:
```
__variable_name:
  scope: ...
  operation: ...
  value: ...
```

The two leading underscores are stripped out of the variable name and the
`value` key allows you to add the value for the variable as if it were defined
as: `variable_name: <value>`.

The `scope` key defines which pages should be affected by this variables. The
possible values are:

* `branch`: all pages from this point on are affected (ie. immediate children
  and, recursively, all descendants). This is the default.

* `level`: only pages in this particular directory are affected (ie. only
  immediate children). If the variable already exists, the new value will only
  affect immediate children and pages in subdirectories under this one will see
  the old value.

* `final`: like `level` but the old value will not be passed down to pages in
  subdirectories under this one (the variable will be undefined).

The `operation` key allows you to define what to do if a variable of the same
name already exists. The possible values depend on the type of the variable:

* `replace`: [For scalars, lists and dictionaries] If there's a variable of the
  same name, replace its value by the new one. This is the default.

* `merge`: [For dictionaries] The final value is the combination of the new and
  the old dictionaries.

* `append`: [For lists] The final value is the old list with then new elements
  appended at the end.

* `delete`: [For scalars, lists and dictionaries] The variable is removed as if
  it was not defined. You can't specify a value in this case.

Examples:

<table>
  <tr>
    <th>Prev. definition</th>
    <th>New definition</th>
    <th>Result</th>
  </tr>
  <tr>
    <td>
      <pre lang="yaml">
        foobar:
          - one
          - two
      </pre>
    </td>
    <td>
      <pre lang="yaml">
        __foobar:
          operation: replace
          value:
            - three
            - four
      </pre>
      (Same as not using the extended notation)
    </td>
    <td>
      <pre lang="yaml">
        foobar:
          - three
          - four
      </pre>
    </td>
  </tr>
  <tr>
    <td>
      <pre lang="yaml">
        foobar:
          a: 1
          b: 2
      </pre>
    </td>
    <td>
      <pre lang="yaml">
        __foobar:
          operation: merge
          value:
            a: 5
            c: 3
      </pre>
      (Same as not using the extended notation)
    </td>
    <td>
      <pre lang="yaml">
        foobar:
          a: 5
          b: 2
          c: 3
      </pre>
    </td>
  </tr>
  <tr>
    <td>
      <pre lang="yaml">
        foobar:
          - one
          - two
      </pre>
    </td>
    <td>
      <pre lang="yaml">
        __foobar:
          operation: append
          value:
            - three
            - four
      </pre>
      (Same as not using the extended notation)
    </td>
    <td>
      <pre lang="yaml">
        foobar:
          - one
          - two
          - three
          - four
      </pre>
    </td>
  </tr>
  <tr>
    <td>
      <pre lang="yaml">
        foobar: 5
      </pre>
    </td>
    <td>
      <pre lang="yaml">
        __foobar:
          operation: delete
      </pre>
      (Same as not using the extended notation)
    </td>
    <td>
      (undefined)
    </td>
  </tr>
</table>

Since ``branch`` and ``replace`` are the default values, this definition:
```
__foobar:
  scope: branch
  operation: replace
  value: 100
```
is equivalent to:
```
foobar: 100
```
There are cases in which playing with the scope and operation is very useful.
For instance, imagine that you want to add a CSS file only to pages of a given
directory. If the CSS files to be used in templates are defined like this at the
root of your site:
```
stylesheets:
  - /static/css/reset.css
  - /static/css/my-site.css
```
Then you can add one more CSS file to the pages of that directory by adding the
following at its `_values.yaml` file:
```
__foobar:
  scope: level
  operation: append
  value:
    - /static/css/some-changes.css
```

Reference
---------

### Commands

```
spekulatio build [--content-dir=./content] [--template-dir=./templates] [--build-dir=./build] [--no-cache]
```
Build site. ``--template-dir`` can appear multiple times.

By default, cache is used, which means that only pages that are modified are
regenerated. Passing ``--no-cache`` regenerates all files (**Caution! all contents
of ``--build-dir`` are deleted in this case!**).

